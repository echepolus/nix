#+TITLE: Emacs
#+STARTUP: content

* Package Sources & Definitions
#+NAME: sources-definitions
#+BEGIN_SRC emacs-lisp

  (require 'package)
  (unless (assoc-default "melpa" package-archives)
     (add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t))
  (unless (assoc-default "nongnu" package-archives)
     (add-to-list 'package-archives '("nongnu" . "https://elpa.nongnu.org/nongnu/") t))

  (setq user-full-name "echepolus"
    user-mail-address "a.kotominn@gmail.com")

  (defun system-is-mac ()
    (string-equal system-type "darwin"))

  (defun system-is-linux ()
    (string-equal system-type "gnu/linux"))

  (when (system-is-mac)
    (let ((home-dir (getenv "HOME")))
      (setenv "PATH" (concat (getenv "PATH") ":" home-dir "/.nix-profile/bin:/usr/bin"))
      (setq exec-path (append (list (concat home-dir "/bin")
                                   "/profile/bin"
                                   (concat home-dir "/.npm-packages/bin")
                                   (concat home-dir "/.nix-profile/bin")
                                   "/nix/var/nix/profiles/default/bin"
                                   "/usr/local/bin"
                                   "/usr/bin")
                             exec-path))))

#+END_SRC

* UI
** General
#+NAME: general-ui
#+BEGIN_SRC emacs-lisp

  (column-number-mode)
  (scroll-bar-mode 0)
  (menu-bar-mode -1)
  (tool-bar-mode 0)
  (winner-mode 1)
  (blink-cursor-mode -1)
  (use-package rainbow-delimiters
    :hook (prog-mode . rainbow-delimiters-mode))
  (setq inhibit-startup-screen t)
  (setq initial-scratch-message nil)
  (setq confirm-kill-emacs #'y-or-n-p)
  (use-package gcmh
    :ensure nil
    :demand t
    :config (gcmh-mode 1))
  (setq use-short-answers t)
  (global-visual-line-mode t)
  (global-auto-revert-mode t)
  (show-paren-mode t)
  (setq show-paren-style 'mixed)
  (setq show-paren-delay 0)
  (setq warning-minimum-level :error)
  (dolist (mode '(prog-mode-hook))
    (add-hook mode #'display-line-numbers-mode 0))
  (setq frame-resize-pixelwise t)

#+END_SRC

** Modeline
#+NAME: modeline
#+BEGIN_SRC emacs-lisp

  (use-package all-the-icons)

  (use-package f
    :ensure nil
    :demand t)

  (use-package doom-modeline
    :after f
    :init (doom-modeline-mode 1))

#+END_SRC

** Ace-window
#+NAME: easy-window-motions
#+BEGIN_SRC emacs-lisp

  (global-unset-key (kbd "M-o"))

  (use-package ace-window
    :bind (("M-o" . ace-window))
    :custom
      (aw-scope 'frame)
      (aw-keys '(?a ?r ?s ?t ?g ?m ?n ?e ?i ?o))
      (aw-minibuffer-flag t)
    :config
      (ace-window-display-mode 1)
      (advice-add 'ace-select-window :after #'eu/auto-resize))
  
  (setopt auto-resize-ratio 0.7)

  (defun eu/auto-resize ()
    (let* ((height (floor (* auto-resize-ratio (frame-height))))
           (width (floor (* auto-resize-ratio (frame-width))))
           (h-diff (max 0 (- height (window-height))))
           (w-diff (max 0 (- width (window-width)))))
      (enlarge-window h-diff)
      (enlarge-window w-diff t)))
  (setopt window-min-height 10)
  (setopt window-min-width 10)

  (advice-add 'other-window :after (lambda (&rest args) (eu/auto-resize)))
  (advice-add 'windmove-up    :after 'eu/auto-resize)
  (advice-add 'windmove-down  :after 'eu/auto-resize)
  (advice-add 'windmove-right :after 'eu/auto-resize)
  (advice-add 'windmove-left  :after 'eu/auto-resize)

#+END_SRC

** Fonts
#+NAME: fonts
#+BEGIN_SRC emacs-lisp

  (use-package fontaine
    :ensure nil
    :hook
    ((after-init . fontaine-mode)
     (after-init . (lambda ()
                     (fontaine-set-preset (or (fontaine-restore-latest-preset) 'regular)))))
    :bind (("C-c f" . fontaine-set-preset)
           ("C-c F" . fontaine-toggle-preset))
    :config
  (defconst my/mono "Geist Mono")
  (defconst my/var  "SF Pro Text")
    (setq fontaine-presets
        `(
          ;; компактный
          (small
           :default-family ,my/mono
           :default-weight light 
           :default-height 110
           :fixed-pitch-family ,my/mono
           :variable-pitch-family ,my/var)

          (regular
           :default-family ,my/mono
           :default-weight regular 
           :default-height 160
           :fixed-pitch-family ,my/mono
           :variable-pitch-family ,my/var)

          (medium
           :inherit regular
           :default-height 150)

          (large
           :inherit regular
           :default-height 180)

          (presentation
           :inherit regular
           :default-height 200)

          (jumbo
           :inherit regular
           :default-height 230)

          (coding
           :inherit regular
           :default-height 150)

          ;; fallback по умолчанию (используется как база для наследования)
          (t
           :default-family ,my/mono
           :default-weight regular
           :default-slant normal
           :default-width normal
           :default-height 140

           :fixed-pitch-family ,my/mono
           :fixed-pitch-height 1.0

           :variable-pitch-family ,my/var
           :variable-pitch-height 1.0

           :mode-line-active-height 1.0
           :mode-line-inactive-height 1.0
           :header-line-height 1.0
           :line-number-height 1.0
           :tab-bar-height 1.0
           :tab-line-height 1.0
           :bold-weight bold
           :italic-slant italic)))

  (with-eval-after-load 'pulsar
    (add-hook 'fontaine-set-preset-hook #'pulsar-pulse-line)))

#+END_SRC

** Spacious-padding
#+NAME: padding
#+BEGIN_SRC emacs-lisp

  (require 'spacious-padding)
  (setq spacious-padding-widths
        '( :internal-border-width 15
           :header-line-width 4
           :mode-line-width 5
           :tab-width 4
           :right-divider-width 30
           :scroll-bar-width 8
           :fringe-width 8))
  (setq spacious-padding-subtle-frame-lines
        `( :mode-line-active 'default
           :mode-line-inactive vertical-border))
  (spacious-padding-mode 1)

#+END_SRC

** Minibuffers
*** General
#+NAME: general-minibuffers
#+BEGIN_SRC emacs-lisp

  (use-package minibuffer
    :ensure nil
    :config
    (setq completion-styles '(basic substring initials flex orderless)) ; also see `completion-category-overrides'
    (setq completion-pcm-leading-wildcard t)) ; Emacs 31: make `partial-completion' behave like `substring'

  (setq completion-ignore-case t)
  (setq read-buffer-completion-ignore-case t)
  (setq-default case-fold-search t)
  (setq read-file-name-completion-ignore-case t)
  (file-name-shadow-mode 1)

  (use-package mb-depth
    :ensure nil
    :hook (after-init . minibuffer-depth-indicate-mode)
    :config
    (setq read-minibuffer-restore-windows nil)
    (setq enable-recursive-minibuffers t))

#+END_SRC

*** Orderless
#+NAME: orderless
#+BEGIN_SRC emacs-lisp

  (use-package orderless
    :ensure nil
    :demand t
    :after minibuffer
    :config
    (setq orderless-matching-styles '(orderless-prefixes orderless-regexp))
    (setq orderless-smart-case nil)
    :bind ( :map minibuffer-local-completion-map
            ("SPC" . nil)
            ("?" . nil)))

#+END_SRC

*** Vertico
#+NAME: vertico
#+BEGIN_SRC emacs-lisp

  (use-package vertico
    :ensure nil
    :config
    (setq vertico-cycle t
            vertico-count 10
            vertico-resize t)
    (vertico-mode 1)
    (add-hook 'rfn-eshadow-update-overlay-hook #'vertico-directory-tidy))

  (use-package vertico-posframe
    :after vertico
    :config
    (vertico-posframe-mode 1)
    (setq vertico-posframe-parameters
          '((left-fringe . 5)
            (right-fringe . 5)))
    (setq vertico-posframe-poshandler #'posframe-poshandler-frame-center))

#+END_SRC

*** Marginalia
#+NAME: marginalia
#+BEGIN_SRC emacs-lisp

  (use-package marginalia
    :bind (:map minibuffer-local-map
                ("M-A" . marginalia-cycle))
    :init (marginalia-mode 1))

#+END_SRC

*** Consult
#+NAME: consult
#+BEGIN_SRC emacs-lisp

  (use-package consult
    :bind (;; C-c bindings in `mode-specific-map'
           ("C-c M-x" . consult-mode-command)
           ("C-c h" . consult-history)
           ("C-c k" . consult-kmacro)
           ("C-c m" . consult-man)
           ("C-c i" . consult-info)
           ([remap Info-search] . consult-info)
           ;; C-x bindings in `ctl-x-map'
           ("C-x M-:" . consult-complex-command)     ;; orig. repeat-complex-command
           ("C-x b" . consult-buffer)                ;; orig. switch-to-buffer
           ("C-x 4 b" . consult-buffer-other-window) ;; orig. switch-to-buffer-other-window
           ("C-x 5 b" . consult-buffer-other-frame)  ;; orig. switch-to-buffer-other-frame
           ("C-x t b" . consult-buffer-other-tab)    ;; orig. switch-to-buffer-other-tab
           ("C-x r b" . consult-bookmark)            ;; orig. bookmark-jump
           ("C-x p b" . consult-project-buffer)      ;; orig. project-switch-to-buffer
           ;; Custom M-# bindings for fast register access
           ("M-#" . consult-register-load)
           ("M-'" . consult-register-store)          ;; orig. abbrev-prefix-mark (unrelated)
           ("C-M-#" . consult-register)
           ;; Other custom bindings
           ("M-y" . consult-yank-pop)                ;; orig. yank-pop
           ;; M-g bindings in `goto-map'
           ("M-g e" . consult-compile-error)
           ("M-g f" . consult-flymake)               ;; Alternative: consult-flycheck
           ("M-g g" . consult-goto-line)             ;; orig. goto-line
           ("M-g M-g" . consult-goto-line)           ;; orig. goto-line
           ("M-g o" . consult-outline)               ;; Alternative: consult-org-heading
           ("M-g m" . consult-mark)
           ("M-g k" . consult-global-mark)
           ("M-g i" . consult-imenu)
           ("M-g I" . consult-imenu-multi)
           ;; M-s bindings in `search-map'
           ("M-s f" . consult-find)                  ;; Alternative: consult-fd
           ("M-s c" . consult-locate)
           ("M-s g" . consult-grep)
           ("M-s G" . consult-git-grep)
           ("M-s r" . consult-ripgrep)
           ("M-s l" . consult-line)
           ("M-s L" . consult-line-multi)
           ("M-s k" . consult-keep-lines)
           ("M-s u" . consult-focus-lines)
           ;; Isearch integration
           ("M-s e" . consult-isearch-history)
           :map isearch-mode-map
           ("M-e" . consult-isearch-history)         ;; orig. isearch-edit-string
           ("M-s e" . consult-isearch-history)       ;; orig. isearch-edit-string
           ("M-s l" . consult-line)                  ;; needed by consult-line to detect isearch
           ("M-s L" . consult-line-multi)            ;; needed by consult-line to detect isearch
           ;; Minibuffer history
           :map minibuffer-local-map
           ("M-s" . consult-history)                 ;; orig. next-matching-history-element
           ("M-r" . consult-history))                ;; orig. previous-matching-history-element

    ;; Enable automatic preview at point in the *Completions* buffer. This is
    ;; relevant when you use the default completion UI.
    :hook (completion-list-mode . consult-preview-at-point-mode)

    ;; The :init configuration is always executed (Not lazy)
    :init

    ;; Tweak the register preview for `consult-register-load',
    ;; `consult-register-store' and the built-in commands.  This improves the
    ;; register formatting, adds thin separator lines, register sorting and hides
    ;; the window mode line.
    (advice-add #'register-preview :override #'consult-register-window)
    (setq register-preview-delay 0.5)

    ;; Use Consult to select xref locations with preview
    (setq xref-show-xrefs-function #'consult-xref
          xref-show-definitions-function #'consult-xref)

    ;; Configure other variables and modes in the :config section,
    ;; after lazily loading the package.
    :config

    ;; Optionally configure preview. The default value
    ;; is 'any, such that any key triggers the preview.
    ;; (setq consult-preview-key 'any)
    ;; (setq consult-preview-key "M-.")
    ;; (setq consult-preview-key '("S-<down>" "S-<up>"))
    ;; For some commands and buffer sources it is useful to configure the
    ;; :preview-key on a per-command basis using the `consult-customize' macro.

    (setq consult-narrow-key "<") ;; "C-+"

    ;; Optionally make narrowing help available in the minibuffer.
    ;; You may want to use `embark-prefix-help-command' or which-key instead.
    ;; (keymap-set consult-narrow-map (concat consult-narrow-key " ?") #'consult-narrow-help)
  )

#+END_SRC

*** Embark
#+NAME: embark
#+BEGIN_SRC emacs-lisp

  (use-package embark
    :ensure nil
    :bind (("C-." . embark-act)
           :map minibuffer-local-map
           ("C-c C-c" . embark-collect)
           ("C-c C-e" . embark-export)))
  (use-package embark-consult
    :ensure nil)

#+END_SRC

*** Wgrep
#+NAME: wgrep
#+BEGIN_SRC emacs-lisp

  (use-package wgrep
    :ensure nil
    :bind ( :map grep-mode-map
            ("e" . wgrep-change-to-wgrep-mode)
            ("C-x C-q" . wgrep-change-to-wgrep-mode)
            ("C-c C-c" . wgrep-finish-edit)))

#+END_SRC

*** Ivy
#+name: ivy-config
#+begin_src emacs-lisp

  ;; (use-package ivy
  ;;    :diminish
  ;;    :bind (("C-s" . swiper)
  ;;           :map ivy-minibuffer-map
  ;;           ("TAB" . ivy-alt-done)
  ;;           ("C-l" . ivy-alt-done)
  ;;           ("C-j" . ivy-next-line)
  ;;           ("C-k" . ivy-previous-line)
  ;;           :map ivy-switch-buffer-map
  ;;           ("C-k" . ivy-previous-line)
  ;;           ("C-l" . ivy-done)
  ;;           ("C-d" . ivy-switch-buffer-kill)
  ;;           :map ivy-reverse-i-search-map
  ;;           ("C-k" . ivy-previous-line)
  ;;           ("C-d" . ivy-reverse-i-search-kill))
  ;;    :config
  ;;    (ivy-mode 1))

  ;;  (use-package ivy-rich
  ;;    :init
  ;;    (ivy-rich-mode 1))
   
#+end_src

** Dashboard
#+NAME: enlight-settings
#+BEGIN_SRC emacs-lisp

  (use-package dashboard
    :ensure nil
    :config
    (dashboard-setup-startup-hook)
    (setq dashboard-startup-banner 'ascii
          dashboard-center-content t
          dashboard-items '((projects . 5)
                             (recents  . 5)))
    (setq dashboard-set-footer nil))
    (setq dashboard-set-file-icons t)
    (setq dashboard-projects-backend 'projectile)
    (setq initial-buffer-choice (lambda ()
                                    (get-buffer-create "*dashboard*")
                                    (dashboard-refresh-buffer)))

#+END_SRC

** Themes
#+NAME: doric-themes-autothemer
#+BEGIN_SRC emacs-lisp

  (use-package doric-themes
    :ensure nil
    :demand t
    :config
    (setq doric-themes-to-toggle '(doric-dark doric-light))
    (setq doric-themes-to-rotate doric-themes-collection)
    (doric-themes-load-random 'dark)
    :bind ("M-<f5>" . doric-themes-rotate))

#+END_SRC

** Pulsar
#+NAME: pulsar
#+BEGIN_SRC emacs-lisp

  (use-package pulsar
    :ensure nil
    :bind
    (:map global-map
      ("C-x l" . pulsar-pulse-line)
      ("C-x L" . pulsar-highlight-permanently-dwim))
    :init (pulsar-global-mode 1)
    :config
    (setq pulsar-delay 0.055)
    (setq pulsar-iterations 5)
    (setq pulsar-face 'pulsar-green)
    (setq pulsar-region-face 'pulsar-yellow)
    (setq pulsar-highlight-face 'pulsar-magenta))

#+END_SRC

* Files
** Save Place'n'History
#+NAME: save-place-savehist
#+BEGIN_SRC emacs-lisp

  (save-place-mode 1)
  (setq save-place-file "~/.local/state/emacs/saveplace")
  (savehist-mode 1)
  (setq savehist-additional-variables
        '(search-ring
          regexp-search-ring
          kill-ring
          register-alist
          org-refile-history
          org-capture-history))
  (setq savehist-file "~/.local/state/emacs/savehist")
  (setq backup-directory-alist
        `((".*" . "~/.local/state/emacs/backup"))
        backup-by-copying t
        version-control t
        delete-old-versions t)
  (setq undo-tree-history-directory-alist '(("." . "~/.local/state/emacs/undo")))

  (setq auto-save-file-name-transforms
        `((".*" "~/.local/state/emacs/" t)))
  (setq lock-file-name-transforms
        `((".*" "~/.local/state/emacs/lock-files/" t)))

#+END_SRC

** Recent Files
#+NAME: recentf-mode
#+BEGIN_SRC emacs-lisp

  (use-package recentf
    :ensure nil
    :init
    (setq recentf-max-saved-items 100
          recentf-max-menu-items 50
          recentf-save-file "~/.local/state/emacs/recentf")
    :config
    (recentf-mode 1))

  (global-set-key (kbd "C-x C-r") 'recentf-open-files)

#+END_SRC

** File browser
#+BEGIN_SRC emacs-lisp

  (use-package nerd-icons-dired)

  (use-package dired
    :ensure nil
    :defer 1
    :commands (dired dired-jump)
    :config
    (setq dired-listing-switches "-agho --group-directories-first")
    (setq dired-hide-details-hide-symlink-targets nil)
    (put 'dired-find-alternate-file 'disabled nil)
    (setq delete-by-moving-to-trash t)
    (add-hook 'dired-load-hook
              (lambda ()
                (interactive)
                (dired-collapse)))
    (add-hook 'dired-mode-hook
              (lambda ()
                (interactive)
                (nerd-icons-dired-mode 1)
                (hl-line-mode 1))))
  (add-hook 'dired-mode-hook 'dired-hide-details-mode)t

  (use-package dired-ranger)
  (use-package dired-collapse)

  (when (system-is-mac)
    (setq insert-directory-program
          (expand-file-name ".nix-profile/bin/ls" (getenv "HOME"))))

#+END_SRC

** TRAMP
#+NAME: tramp
#+BEGIN_SRC emacs-lisp

  (use-package tramp
    :ensure nil
    :config
    (setq tramp-shell-prompt-pattern "^[^$>\n]*[#$%>] *\\(\[[0-9;]*[a-zA-Z] *\\)*")
    (setq tramp-connection-timeout 10)
    (add-to-list 'tramp-remote-path 'tramp-own-remote-path)
    (setq vc-ignore-dir-regexp
          (format "\\(%s\\)\\|\\(%s\\)"
                  vc-ignore-dir-regexp
                  tramp-file-name-regexp)))

#+END_SRC

** Notes & Books
#+NAME: denote-calibre
#+BEGIN_SRC emacs-lisp

  (use-package denote
    :ensure nil
    :hook (dired-mode . denote-dired-mode)
    :bind
    (("C-c n n" . denote)
     ("C-c n r" . denote-rename-file)
     ("C-c n l" . denote-link)
     ("C-c n b" . denote-backlinks)
     ("C-c n d" . denote-dired)
     ("C-c n g" . denote-grep))
    :config
    (setq denote-directory (expand-file-name "~/Documents/notes/"))
    (denote-rename-buffer-mode 1))

  (use-package denote-markdown
    :ensure nil
    ;; Bind these commands to key bindings of your choice.
    :commands ( denote-markdown-convert-links-to-file-paths
                denote-markdown-convert-links-to-denote-type
                denote-markdown-convert-links-to-obsidian-type
                denote-markdown-convert-obsidian-links-to-denote-type ))

  (use-package consult-denote
    :ensure nil
    :bind
    (("C-c n f" . consult-denote-find)
     ("C-c n g" . consult-denote-grep))
    :config
    (consult-denote-mode 1))

  (use-package denote-org
    :ensure nil
    :commands
    ;; I list the commands here so that you can discover them more
    ;; easily.  You might want to bind the most frequently used ones to
    ;; the `org-mode-map'.
    ( denote-org-link-to-heading
      denote-org-backlinks-for-heading

      denote-org-extract-org-subtree

      denote-org-convert-links-to-file-type
      denote-org-convert-links-to-denote-type

      denote-org-dblock-insert-files
      denote-org-dblock-insert-links
      denote-org-dblock-insert-backlinks
      denote-org-dblock-insert-missing-links
      denote-org-dblock-insert-files-as-headings))

  (use-package denote-journal
    :ensure nil
    ;; Bind those to some key for your convenience.
    :commands ( denote-journal-new-entry
                denote-journal-new-or-existing-entry
                denote-journal-link-or-create-entry )
    :hook (calendar-mode . denote-journal-calendar-mode)
    :config
    ;; Use the "journal" subdirectory of the `denote-directory'.  Set this
    ;; to nil to use the `denote-directory' instead.
    (setq denote-journal-directory
          (expand-file-name "journal" denote-directory))
    ;; Default keyword for new journal entries. It can also be a list of
    ;; strings.
    (setq denote-journal-keyword "journal")
    ;; Read the doc string of `denote-journal-title-format'.
    (setq denote-journal-title-format 'day-date-month-year))

  (use-package denote-sequence
    :ensure t
    :bind
    ( :map global-map
      ;; Here we make "C-c n s" a prefix for all "[n]otes with [s]equence".
      ;; This is just for demonstration purposes: use the key bindings
      ;; that work for you.  Also check the commands:
      ;;
      ;; - `denote-sequence-new-parent'
      ;; - `denote-sequence-new-sibling'
      ;; - `denote-sequence-new-child'
      ;; - `denote-sequence-new-child-of-current'
      ;; - `denote-sequence-new-sibling-of-current'
      ("C-c n s s" . denote-sequence)
      ("C-c n s f" . denote-sequence-find)
      ("C-c n s l" . denote-sequence-link)
      ("C-c n s d" . denote-sequence-dired)
      ("C-c n s r" . denote-sequence-reparent)
      ("C-c n s c" . denote-sequence-convert))
    :config
    ;; The default sequence scheme is `numeric'.
    (setq denote-sequence-scheme 'alphanumeric))

  (use-package citar
    :custom
    (citar-bibliography '("~/Documents/library/references.bib")))

  (use-package nov
    :mode ("\\.epub\\'" . nov-mode))

  (use-package calibredb
    :ensure nil
    :commands (calibredb)
    :init
    (setq calibredb-root-dir "~/Documents/calibrary")
    (setq calibredb-db-dir (expand-file-name "metadata.db" calibredb-root-dir))
    (setq calibredb-library-alist '(("~/Documents/calibrary")))
    (setq calibredb-search-page-max-rows 100)
    (setq calibredb-id-width 0)
    (setq calibredb-comment-width 0)
    (setq calibredb-program "/Applications/calibre.app/Contents/MacOS/calibredb"))

#+END_SRC

** PDF
#+BEGIN_SRC emacs-lisp
  (use-package pdf-tools
    :defer t
    :commands (pdf-loader-install)
    :mode "\\.pdf\\'"
    :bind (:map pdf-view-mode-map
                ("i" . pdf-view-next-line-or-next-page)
                ("n" . pdf-view-previous-line-or-previous-page)
                ("C-=" . pdf-view-enlarge)
                ("C--" . pdf-view-shrink))
    :init (pdf-loader-install)
    :config (add-to-list 'revert-without-query ".pdf")
    (setq pdf-history-enabled t)
    (setq pdf-view-auto-restore 'position)
    (save-place-mode 1)

   (add-hook 'pdf-view-mode-hook #'(lambda () (interactive) (display-line-numbers-mode -1))))

#+END_SRC

* Terminal
#+NAME: terminal
#+BEGIN_SRC emacs-lisp

  (use-package vterm
    :commands vterm
    :config
    (setq term-prompt-regexp "^[^#$%>\n]*[#$%>] *")
    (setq vterm-shell "zsh")
    (setq vterm-max-scrollback 10000))

#+END_SRC

* Keyboard
#+NAME: general-keyboard-config
#+BEGIN_SRC emacs-lisp

  (defun config-visit ()
    (interactive)
    (find-file "/Users/alexeykotomin/.config/nix/modules/shared/config/emacs/config.org"))
  (defun my-projects-visit ()
    (interactive)
    (find-file "/Users/alexeykotomin/org/20260105T151859--действующие-проекты-и-книги__задачи_книги_проекты.org"))
  (global-set-key (kbd "C-c d") 'config-visit)
  (global-set-key (kbd "C-c p") 'my-projects-visit)
  ;; Scroll up and down
  (global-set-key (kbd "s-<down>") (kbd "C-u 1 C-v"))
  (global-set-key (kbd "s-<up>") (kbd "C-u 1 M-v"))
  ;; Kill this buffer
  (global-set-key (kbd "C-1") 'kill-this-buffer)
  ;; Clean whitespace
  (global-set-key (kbd "C-c w") 'whitespace-cleanup)
  ;; Hippie expand
  (global-set-key (kbd "M-/") 'hippie-expand)
  ;; Remember-mode
  (global-set-key (kbd "C-c r") 'remember)
  ;; Quickly access my fav folder in dired
  (global-set-key (kbd "<f5>") (lambda() (interactive)(find-file "~/")))
  (setq-default indent-tabs-mode nil
              js-indent-level 2
              tab-width 2)
  (global-set-key (kbd "<C-tab>") 'next-buffer)
  (global-set-key (kbd "<C-S-tab>") 'previous-buffer) 
  (global-set-key (kbd "<escape>") 'keyboard-escape-quit)

#+END_SRC

** Reverse-im
#+NAME: keyboard
#+BEGIN_SRC emacs-lisp

  ;; Needed for `:after char-fold' to work
  (use-package char-fold
    :custom
    (char-fold-symmetric t)
    (search-default-mode #'char-fold-to-regexp))

  (use-package reverse-im
    :ensure nil
    :demand t
    :after char-fold
    :bind
    ("M-Τ" . reverse-im-translate-word) ; to fix a word written in the wrong layout
    :custom
    ;; cache generated keymaps
    (reverse-im-cache-file (locate-user-emacs-file "reverse-im-cache.el"))
    ;; use lax matching
    (reverse-im-char-fold t)
    ;; advice read-char to fix commands that use their own shortcut mechanism
    (reverse-im-read-char-advice-function #'reverse-im-read-char-include)
    (reverse-im-input-methods '("russian-computer" "greek"))
    :config
    (reverse-im-mode t)) ; turn the mode on

#+END_SRC

** EVIL
#+name: evil-config
#+begin_src emacs-lisp

  ;; (use-package evil
  ;;   :init
  ;;   (setq evil-want-integration t)
  ;;   (setq evil-want-keybinding nil)
  ;;   (setq evil-want-C-u-scroll t)
  ;;   (setq evil-want-C-i-jump nil)
  ;;   :config
  ;;   (evil-mode 1)
  ;;   (define-key evil-insert-state-map (kbd "C-g") 'evil-normal-state)
  ;;   (define-key evil-insert-state-map (kbd "C-h") 'evil-delete-backward-char-and-join)

  ;;   ;; Use visual line motions even outside of visual-line-mode buffers
  ;;   (evil-global-set-key 'motion "j" 'evil-next-visual-line)
  ;;   (evil-global-set-key 'motion "k" 'evil-previous-visual-line)

  ;;   (evil-set-initial-state 'messages-buffer-mode 'normal)
  ;;   (evil-set-initial-state 'dashboard-mode 'normal))

  ;; (use-package evil-collection
  ;;   :after evil
  ;;   :config
  ;;   (evil-collection-init))

#+end_src
  
** Company
#+name: company-config
#+begin_src emacs-lisp

  ;; (use-package company
  ;;   :after lsp-mode
  ;;   :hook (lsp-mode . company-mode)
  ;;   :bind (:map company-active-map
  ;;          ("<tab>" . company-complete-selection))
  ;;         (:map lsp-mode-map
  ;;          ("<tab>" . company-indent-or-complete-common))
  ;;   :custom
  ;;   (company-minimum-prefix-length 1)
  ;;   (company-idle-delay 0.0))

  ;; (use-package company-box
  ;;   :hook (company-mode . company-box-mode))

#+end_src

* Org
#+NAME: org-mode-quick-entry
#+BEGIN_SRC emacs-lisp

  (use-package math-preview
    :custom (math-preview-command "/Users/alexeykotomin/.nix-profile/bin/math-preview"))

#+END_SRC

** ORG-agenda
#+name: org-agenda
#+begin_src emacs-lisp

  (setq org-directory "~/org")
  (setq org-agenda-files '("~/org"))
  (setq org-todo-keywords
        '((sequence "TODO" "DONE")))
  (setq org-log-done 'time)
  (setq org-archive-location "~/org/archive.org::")
  (setq org-capture-templates
        '(("i" "Inbox" entry
           (file "~/org/inbox.org")
           "* TODO %?\n  %U")))

  (setq org-agenda-custom-commands
        '(("d" "Daily"
           ((agenda "" ((org-agenda-span 1)))
            (todo "NEXT")))))

#+end_src

* Code
** LSP-mode
#+name: lsp-mode
#+begin_src emacs-lisp

  (defun efs/lsp-mode-setup ()
    (setq lsp-headerline-breadcrumb-segments '(path-up-to-project file symbols))
    (lsp-headerline-breadcrumb-mode))

  (use-package lsp-mode
    :commands (lsp lsp-deferred)
    :init (setq lsp-keymap-prefix "C-c l")
    :config (lsp-enable-which-key-integration t))

  (use-package lsp-ui
    :hook (lsp-mode . lsp-ui-mode)
    :custom
    (lsp-ui-doc-position 'bottom))

  (use-package lsp-ivy)

  (use-package lsp-treemacs
    :after lsp)
  
#+end_src

** C/C++
#+name: c-language
#+begin_src emacs-lisp

  (use-package indent-bars
    :ensure nil
    :custom
    (indent-bars-treesit-support t)
    (indent-bars-treesit-wrap '((c argument_list parameter_list init_declarator parenthesized_expression))))
                                          ; alternative to wrap:
    ; (indent-bars-no-descend-lists '(?\[ ?\()) ; prevent {} from being treated like lists!

#+end_src
** Shell scripts
#+NAME: shell-scripts
#+BEGIN_SRC emacs-lisp
  (add-to-list 'auto-mode-alist '("\\.env" . shell-script-mode))
#+END_SRC

** kbd
#+NAME: kbd
#+BEGIN_SRC emacs-lisp
  (add-to-list 'auto-mode-alist '("\\.kbd\\'" . lisp-mode))
#+END_SRC

** Nix
#+NAME: nix-mode
#+begin_src emacs-lisp
  (use-package nix-mode
    :mode "\\.nix\\'")
#+end_src

** Emacs Development Evironment
#+name: ede-mode
#+begin_src emacs-lisp

  (setq ede-project-directories-file
      (expand-file-name "ede-projects.el" user-emacs-directory))
  (load ede-project-directories-file 'noerror)

#+end_src

** Load languages to run in org mode code blocks
#+name: lang-org
#+BEGIN_SRC emacs-lisp

  (with-eval-after-load 'org
    (org-babel-do-load-languages
    'org-babel-load-languages
    '(
      (emacs-lisp . t)
      (python . t)
      (sql . t)
      (shell . t))))

#+END_SRC

* Learning Emacs
#+name: popup
#+BEGIN_SRC emacs-lisp
  
  (use-package which-key
    :ensure nil
    :init
    (setq which-key-idle-delay 0.3
          which-key-idle-secondary-delay 0.1)
    :config
    (which-key-mode))

  (use-package helpful
    :ensure nil
    :commands (helpful-callable helpful-variable helpful-key)
    :bind
    ([remap describe-function] . helpful-callable)
    ([remap describe-command]  . helpful-callable)
    ([remap describe-variable] . helpful-variable)
    ([remap describe-key]      . helpful-key))

#+END_SRC

* Ancient Greek
[[https://www.youtube.com/watch?v=oToTtoK1PQ0&list=WL&index=9][Source]]
#+name: ancient-greek
#+begin_src emacs-lisp

  ;; Key bindings:
  ;; - Toggle Hebrew (biblical-sil): C-\
  ;; - Toggle Greek (babel): C-|

  ;; Type hard break for Hebrew to English
  (define-key 'iso-transl-ctl-x-8-map "f" [?‎])
  (setq alternative-input-methods
        '(("greek-babel" . [?\C-|])))

  (setq default-input-method
        (caar alternative-input-methods))

  (defun toggle-alternative-input-method (method &optional arg interactive)
    "Toggle input METHOD similar to `toggle-input-method'.
  Uses METHOD instead of `default-input-method'.
  With ARG, behaves like standard toggle-input-method."
    (if arg
        (toggle-input-method arg interactive)
      (let ((previous-input-method current-input-method))
        (when current-input-method
          (deactivate-input-method))
        (unless (and previous-input-method
                     (string= previous-input-method method))
          (activate-input-method method)))))

  (defun reload-alternative-input-methods ()
    "Set up global key bindings for alternative input methods.
  Creates toggle functions for each method in `alternative-input-methods'."
    (dolist (config alternative-input-methods)
      (let ((method (car config)))
        (global-set-key (cdr config)
                        `(lambda (&optional arg interactive)
                           ,(concat "Behaves similar to `toggle-input-method', but uses \""
                                    method "\" instead of `default-input-method'")
                           (interactive "P\np")
                           (toggle-alternative-input-method ,method arg interactive))))))

  (reload-alternative-input-methods)

  ;;; Dynamic Cursor Adjustment

  (defun my-adjust-cursor-for-language ()
    "Set cursor to bar in Greek/Hebrew region, box otherwise.
  Checks characters within 5 positions before and after point."
    (let ((greek-or-hebrew-nearby nil))
      ;; Check characters within 5 positions before and after
      (save-excursion
        (let ((start (max (point-min) (- (point) 5)))
              (end (min (point-max) (+ (point) 5))))
          (goto-char start)
          (while (and (< (point) end) (not greek-or-hebrew-nearby))
            (let ((char (char-after)))
              (when (and char
                         (memq (char-table-range char-script-table char)
                               '(greek hebrew)))
                (setq greek-or-hebrew-nearby t)))
            (forward-char 1))))
      (setq-local cursor-type (if greek-or-hebrew-nearby '(bar . 2) 'box))))

  (add-hook 'post-command-hook #'my-adjust-cursor-for-language)

  (defun strip-numbers-and-brackets (beg end)
    "Remove numbers and brackets from selected region between BEG and END.
  Also removes leading/trailing spaces and collapses multiple spaces between words.
  Useful for cleaning up Greek/Hebrew text with verse numbers."
    (interactive "r")
    (save-excursion
      (save-restriction
        (narrow-to-region beg end)
        ;; Remove numbers and brackets
        (goto-char (point-min))
        (while (re-search-forward "\\([0-9]+\\|\\[\\|\\]\\)" nil t)
          (replace-match ""))
        ;; Collapse multiple spaces into single space
        (goto-char (point-min))
        (while (re-search-forward " \\{2,\\}" nil t)
          (replace-match " "))
        ;; Remove leading and trailing whitespace from each line
        (goto-char (point-min))
        (while (re-search-forward "^[[:space:]]+" nil t)
          (replace-match ""))
        (goto-char (point-min))
        (while (re-search-forward "[[:space:]]+$" nil t)
          (replace-match "")))))

  (defalias 'grk 'strip-numbers-and-brackets)

  (defun greek-hebrew-flyspell-verify ()
    "Return nil if word at point contains Greek or Hebrew characters.
  This tells flyspell to skip checking this word."
    (save-excursion
      (let ((case-fold-search t)
            (pos (point))
            (greek-hebrew-found nil))
        ;; Check if current word contains Greek or Hebrew
        (skip-chars-backward "^ \t\n\r")
        (while (and (< (point) pos) (not greek-hebrew-found))
          (let* ((char (char-after))
                 (script (and char (char-table-range char-script-table char))))
            (when (memq script '(greek hebrew))
              (setq greek-hebrew-found t)))
          (forward-char 1))
        ;; Return t to check word, nil to skip
        (not greek-hebrew-found))))

  ;; Advice to add Greek/Hebrew checking to existing flyspell predicates
  (defun greek-hebrew-flyspell-advice (orig-fun &rest args)
    "Advice to skip Greek/Hebrew words in addition to mode-specific checks."
    (and (greek-hebrew-flyspell-verify)
         (apply orig-fun args)))

  ;; Apply advice to markdown-mode's flyspell predicate
  (with-eval-after-load 'markdown-mode
    (advice-add 'markdown-flyspell-check-word-p :around
                #'greek-hebrew-flyspell-advice))

  ;; For text-mode and org-mode, set the predicate directly
  (add-hook 'text-mode-hook
            (lambda ()
              (unless (derived-mode-p 'markdown-mode)
                (setq-local flyspell-generic-check-word-predicate
                            #'greek-hebrew-flyspell-verify))))

  (add-hook 'org-mode-hook
            (lambda ()
              (setq-local flyspell-generic-check-word-predicate
                          #'greek-hebrew-flyspell-verify)))

  (set-fontset-font "fontset-default" 'greek (font-spec :family "SBL BibLit" :size 22))
  (set-fontset-font "fontset-default" 'hebrew (font-spec :family "SBL BibLit" :size 20))

  (provide 'my-ancient-greek-tweaks)

#+end_src
