#+TITLE: Emacs
#+STARTUP: content

* Configuration :emacs:
** Personal Information
#+NAME: personal-info
#+BEGIN_SRC emacs-lisp

  (setq user-full-name "Alexey Kotomin"
    user-mail-address "a.kotominn@gmail.com")

#+END_SRC

** Initialization
*** Booting up
#+NAME: startup
#+BEGIN_SRC emacs-lisp

  ;;; Set default frame size and position 
  (setq inhibit-startup-screen t)
  (setq initial-scratch-message nil)
  (setq confirm-kill-emacs #'y-or-n-p)
  
    ;; Smooth out garbage collection
    (use-package gcmh
      :ensure nil  ; Managed by Nix
      :demand t
      :config
      (gcmh-mode 1))

#+END_SRC

*** Add package sources
#+NAME: package-sources
#+BEGIN_SRC emacs-lisp

  (require 'package)
  (unless (assoc-default "melpa" package-archives)
     (add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t))
  (unless (assoc-default "nongnu" package-archives)
     (add-to-list 'package-archives '("nongnu" . "https://elpa.nongnu.org/nongnu/") t))
  
#+END_SRC

*** System Definitions
**** Conditionals
#+NAME: conditionals
#+BEGIN_SRC emacs-lisp
  (defun system-is-mac ()
    "Return true if system is darwin-based (Mac OS X)"
    (string-equal system-type "darwin"))

  (defun system-is-linux ()
    "Return true if system is GNU/Linux-based"
    (string-equal system-type "gnu/linux"))

  ;; Set path for darwin
  (when (system-is-mac)
    (let ((home-dir (getenv "HOME")))
      (setenv "PATH" (concat (getenv "PATH") ":" home-dir "/.nix-profile/bin:/usr/bin"))
      (setq exec-path (append (list (concat home-dir "/bin")
                                   "/profile/bin"
                                   (concat home-dir "/.npm-packages/bin")
                                   (concat home-dir "/.nix-profile/bin")
                                   "/nix/var/nix/profiles/default/bin"
                                   "/usr/local/bin"
                                   "/usr/bin")
                             exec-path))))
#+END_SRC

*** Modes
**** Window minor modes
#+NAME: windows-ui-settings
#+BEGIN_SRC emacs-lisp

  ;; Turn off UI junk
  (column-number-mode)
  (scroll-bar-mode 0)
  (menu-bar-mode -1)
  (tool-bar-mode 0)
  (winner-mode 1) ;; ctrl-c left, ctrl-c right for window undo/redo
  (blink-cursor-mode -1)

  ;; –î–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å –æ–∫–æ–Ω–Ω—ã–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º:
  (setq frame-resize-pixelwise t)  ; –¢–æ—á–Ω–æ—Å—Ç—å –≤ –ø–∏–∫—Å–µ–ª—è—Ö (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ)
  ;; (setq frame-inhibit-implied-resize t)  ; –ù–µ –º–µ–Ω—è—Ç—å —Ä–∞–∑–º–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  
#+END_SRC

**** Colors
***** Rainbow delimiters
#+NAME: rainbow-delmiters
#+BEGIN_SRC emacs-lisp
  (use-package rainbow-delimiters
    :hook (prog-mode . rainbow-delimiters-mode))
#+END_SRC

**** Addons
***** Modeline
#+NAME: modeline
#+BEGIN_SRC emacs-lisp
  (use-package nerd-icons)
  
  ;; f.el - modern file API
  (use-package f
    :ensure nil  ; Managed by Nix
    :demand t)
  
  (use-package doom-modeline
    :ensure nil  ; Managed by Nix
    :after f
    :init (doom-modeline-mode 1))
#+END_SRC

***** Treemacs
#+NAME: treemacs
#+BEGIN_SRC emacs-lisp
  (use-package treemacs
    :config
      (setq treemacs-is-never-other-window 1)
    :bind
      ("C-c t" . treemacs-find-file)
      ("C-c b" . treemacs-bookmark))

  (use-package treemacs-icons-dired)
  (use-package treemacs-nerd-icons)
  (use-package treemacs-projectile)
  (use-package treemacs-magit)
  ;; (use-package treemacs-evil)
#+END_SRC

**** Easy window motions with ace-window
#+NAME: easy-window-motions
#+BEGIN_SRC emacs-lisp
;; Remove binding for facemap-menu, use for ace-window instead
(global-unset-key (kbd "M-o"))

(use-package ace-window
  :bind (("M-o" . ace-window))
  :custom
    (aw-scope 'frame)
    (aw-keys '(?a ?r ?s ?t ?g ?m ?n ?e ?i ?o))
    (aw-minibuffer-flag t)
  :config
    (ace-window-display-mode 1)
    (advice-add 'ace-select-window :after #'win/auto-resize))
#+END_SRC

*** Save Place
This enables save-place-mode, so Emacs remembers the cursor position in each file and restores it when reopening that file.
#+NAME: save-place
#+BEGIN_SRC emacs-lisp
(save-place-mode 1)
(setq save-place-file "~/.local/state/emacs/saveplace")
#+END_SRC

*** Save History
This enables savehist-mode, which saves minibuffer histories‚Äîsearch strings, commands, kill ring entries, and Org refile/capture history‚Äîbetween Emacs sessions.
#+NAME: savehist
#+BEGIN_SRC emacs-lisp
(savehist-mode 1)
(setq savehist-additional-variables
  '(search-ring
    regexp-search-ring
    kill-ring
    register-alist
    org-refile-history
    org-capture-history))
(setq savehist-file "~/.local/state/emacs/savehist")
#+END_SRC

*** Recent Files
This enables recentf-mode so we can quickly reopen files you visited recently. It also binds C-x C-r to the recentf-open-files command.
#+NAME: recentf-mode
#+BEGIN_SRC emacs-lisp
(use-package recentf
  :ensure nil
  :init
  (setq recentf-max-saved-items 100
    recentf-max-menu-items 50
    recentf-save-file "~/.local/state/emacs/recentf")
  :config
    (recentf-mode 1))

(global-set-key (kbd "C-x C-r") 'recentf-open-files)
#+END_SRC

*** Windows
**** Fonts
#+NAME: fonts
#+BEGIN_SRC emacs-lisp
  
  ;;;; Fontaine (font configurations)
  (use-package fontaine
    :ensure nil 
    :hook
    ;; Persist the latest font preset when closing/starting Emacs.
    ((after-init . fontaine-mode)
     (after-init . (lambda ()
                     ;; Set last preset or fall back to desired style from `fontaine-presets'.
                     (fontaine-set-preset (or (fontaine-restore-latest-preset) 'regular)))))
    :bind (("C-c f" . fontaine-set-preset)
           ("C-c F" . fontaine-toggle-preset))
    :config
  ;; –ì–ª–∞–≤–Ω—ã–µ —Å–µ–º–µ–π—Å—Ç–≤–∞ –¥–ª—è macOS
  (defconst my/mono "Geist Mono")
  (defconst my/var  "SF Pro Text") ; –º–æ–∂–Ω–æ —Å–º–µ–Ω–∏—Ç—å –Ω–∞ "San Francisco" / "Inter"

  ;; –ù–∞–±–æ—Ä –ø—Ä–µ—Å–µ—Ç–æ–≤. –í—ã—Å–æ—Ç—ã ‚Äî –≤ ‚Äú—Å–æ—Ç—ã—Ö‚Äù –ø–æ –∫–ª–∞—Å—Å–∏–∫–µ Emacs: 140 ‚âà 14pt.
  (setq fontaine-presets
        `(
          ;; –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π
          (small
           :default-family ,my/mono
           :default-weight light 
           :default-height 110
           :fixed-pitch-family ,my/mono
           :variable-pitch-family ,my/var)

          ;; –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
          (regular
           :default-family ,my/mono
           :default-weight regular 
           :default-height 140
           :fixed-pitch-family ,my/mono
           :variable-pitch-family ,my/var)

          ;; —Å–ª–µ–≥–∫–∞ –∫—Ä—É–ø–Ω–µ–µ
          (medium
           :inherit regular
           :default-height 150)

          ;; –∑–∞–º–µ—Ç–Ω–æ –∫—Ä—É–ø–Ω–µ–µ ‚Äî —É–¥–æ–±–Ω–æ –Ω–∞ —Ä–µ—Ç–∏–Ω–µ/–¥–∏–≤–∞–Ω–µ
          (large
           :inherit regular
           :default-height 170)

          ;; –¥–ª—è –≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–π
          (presentation
           :inherit regular
           :default-height 190)

          ;; –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π
          (jumbo
           :inherit regular
           :default-height 230)

          ;; –ø—Ä–µ—Å–µ—Ç –¥–ª—è –∫–æ–¥–∏–Ω–≥–∞: –Ω–µ–º–Ω–æ–≥–æ –∫–æ–º–ø–∞–∫—Ç–Ω–µ–µ –±–æ–∫—Å—ã UI
          (coding
           :inherit regular
           :default-height 135)

          ;; fallback –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –±–∞–∑–∞ –¥–ª—è –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è)
          (t
           :default-family ,my/mono
           :default-weight regular
           :default-slant normal
           :default-width normal
           :default-height 140

           :fixed-pitch-family ,my/mono
           :fixed-pitch-height 1.0

           :variable-pitch-family ,my/var
           :variable-pitch-height 1.0

           :mode-line-active-height 1.0
           :mode-line-inactive-height 1.0
           :header-line-height 1.0
           :line-number-height 1.0
           :tab-bar-height 1.0
           :tab-line-height 1.0
           :bold-weight bold
           :italic-slant italic)))

    (with-eval-after-load 'pulsar
      (add-hook 'fontaine-set-preset-hook #'pulsar-pulse-line)))

#+END_SRC

**** Spacious-padding
#+NAME: padding 
#+BEGIN_SRC emacs-lisp
  
  (require 'spacious-padding)

  ;; These are the default values, but I keep them here for visibility.
  (setq spacious-padding-widths
        '( :internal-border-width 15
           :header-line-width 4
           :mode-line-width 6
           :tab-width 4
           :right-divider-width 30
           :scroll-bar-width 8
           :fringe-width 8))

  ;; Read the doc string of `spacious-padding-subtle-mode-line' as it
  ;; is very flexible and provides several examples.
  (setq spacious-padding-subtle-frame-lines
        `( :mode-line-active 'default
           :mode-line-inactive vertical-border))

  (spacious-padding-mode 1)

  ;; Set a key binding if you need to toggle spacious padding.
  (define-key global-map (kbd "<f8>") #'spacious-padding-mode)

#+END_SRC

*** Minibuffers 
**** General 
#+NAME: general-minibuffers 
#+BEGIN_SRC emacs-lisp

  (use-package minibuffer
    :ensure nil
    :config
    (setq completion-styles '(basic substring initials flex orderless)) ; also see `completion-category-overrides'
    (setq completion-pcm-leading-wildcard t)) ; Emacs 31: make `partial-completion' behave like `substring'

  ;; settings to ignore letter casing
  (setq completion-ignore-case t)
  (setq read-buffer-completion-ignore-case t)
  (setq-default case-fold-search t)   ; For general regexp
  (setq read-file-name-completion-ignore-case t)
  (file-name-shadow-mode 1)
  
  (use-package mb-depth
    :ensure nil
    :hook (after-init . minibuffer-depth-indicate-mode)
    :config
    (setq read-minibuffer-restore-windows nil) ; Emacs 28
    (setq enable-recursive-minibuffers t))

#+END_SRC

**** Orderless 
#+NAME: orderless 
#+BEGIN_SRC emacs-lisp

  (use-package orderless
    :ensure nil 
    :demand t
    :after minibuffer
    :config
    (setq orderless-matching-styles '(orderless-prefixes orderless-regexp))
    (setq orderless-smart-case nil)

    ;; SPC should never complete: use it for `orderless' groups.
    ;; The `?' is a regexp construct.
    :bind ( :map minibuffer-local-completion-map
            ("SPC" . nil)
            ("?" . nil)))

#+END_SRC

**** Vertico 
#+NAME: vertico 
#+BEGIN_SRC emacs-lisp

  (use-package vertico
    :ensure nil
    :config
    (setq vertico-cycle t)
    (setq vertico-resize nil)
    (vertico-mode 1)
    (add-hook 'rfn-eshadow-update-overlay-hook #'vertico-directory-tidy))

#+END_SRC

**** Marginalia 
#+NAME: marginalia
#+BEGIN_SRC emacs-lisp

  ;; Enable rich annotations using the Marginalia package
  (use-package marginalia
    ;; Bind `marginalia-cycle' locally in the minibuffer.  To make the binding
    ;; available in the *Completions* buffer, add it to the
    ;; `completion-list-mode-map'.
    :bind (:map minibuffer-local-map
                ("M-A" . marginalia-cycle))

    ;; The :init section is always executed.
    :init

    ;; Marginalia must be activated in the :init section of use-package such that
    ;; the mode gets enabled right away. Note that this forces loading the
    ;; package.
    (marginalia-mode))
#+END_SRC

**** Consult
#+NAME: consult 
#+BEGIN_SRC emacs-lisp

  ;; Example configuration for Consult
  (use-package consult
    ;; Replace bindings. Lazily loaded by `use-package'.
    :bind (;; C-c bindings in `mode-specific-map'
           ("C-c M-x" . consult-mode-command)
           ("C-c h" . consult-history)
           ("C-c k" . consult-kmacro)
           ("C-c m" . consult-man)
           ("C-c i" . consult-info)
           ([remap Info-search] . consult-info)
           ;; C-x bindings in `ctl-x-map'
           ("C-x M-:" . consult-complex-command)     ;; orig. repeat-complex-command
           ("C-x b" . consult-buffer)                ;; orig. switch-to-buffer
           ("C-x 4 b" . consult-buffer-other-window) ;; orig. switch-to-buffer-other-window
           ("C-x 5 b" . consult-buffer-other-frame)  ;; orig. switch-to-buffer-other-frame
           ("C-x t b" . consult-buffer-other-tab)    ;; orig. switch-to-buffer-other-tab
           ("C-x r b" . consult-bookmark)            ;; orig. bookmark-jump
           ("C-x p b" . consult-project-buffer)      ;; orig. project-switch-to-buffer
           ;; Custom M-# bindings for fast register access
           ("M-#" . consult-register-load)
           ("M-'" . consult-register-store)          ;; orig. abbrev-prefix-mark (unrelated)
           ("C-M-#" . consult-register)
           ;; Other custom bindings
           ("M-y" . consult-yank-pop)                ;; orig. yank-pop
           ;; M-g bindings in `goto-map'
           ("M-g e" . consult-compile-error)
           ("M-g f" . consult-flymake)               ;; Alternative: consult-flycheck
           ("M-g g" . consult-goto-line)             ;; orig. goto-line
           ("M-g M-g" . consult-goto-line)           ;; orig. goto-line
           ("M-g o" . consult-outline)               ;; Alternative: consult-org-heading
           ("M-g m" . consult-mark)
           ("M-g k" . consult-global-mark)
           ("M-g i" . consult-imenu)
           ("M-g I" . consult-imenu-multi)
           ;; M-s bindings in `search-map'
           ("M-s d" . consult-find)                  ;; Alternative: consult-fd
           ("M-s c" . consult-locate)
           ("M-s g" . consult-grep)
           ("M-s G" . consult-git-grep)
           ("M-s r" . consult-ripgrep)
           ("M-s l" . consult-line)
           ("M-s L" . consult-line-multi)
           ("M-s k" . consult-keep-lines)
           ("M-s u" . consult-focus-lines)
           ;; Isearch integration
           ("M-s e" . consult-isearch-history)
           :map isearch-mode-map
           ("M-e" . consult-isearch-history)         ;; orig. isearch-edit-string
           ("M-s e" . consult-isearch-history)       ;; orig. isearch-edit-string
           ("M-s l" . consult-line)                  ;; needed by consult-line to detect isearch
           ("M-s L" . consult-line-multi)            ;; needed by consult-line to detect isearch
           ;; Minibuffer history
           :map minibuffer-local-map
           ("M-s" . consult-history)                 ;; orig. next-matching-history-element
           ("M-r" . consult-history))                ;; orig. previous-matching-history-element

    ;; Enable automatic preview at point in the *Completions* buffer. This is
    ;; relevant when you use the default completion UI.
    :hook (completion-list-mode . consult-preview-at-point-mode)

    ;; The :init configuration is always executed (Not lazy)
    :init

    ;; Tweak the register preview for `consult-register-load',
    ;; `consult-register-store' and the built-in commands.  This improves the
    ;; register formatting, adds thin separator lines, register sorting and hides
    ;; the window mode line.
    (advice-add #'register-preview :override #'consult-register-window)
    (setq register-preview-delay 0.5)

    ;; Use Consult to select xref locations with preview
    (setq xref-show-xrefs-function #'consult-xref
          xref-show-definitions-function #'consult-xref)

    ;; Configure other variables and modes in the :config section,
    ;; after lazily loading the package.
    :config

    ;; Optionally configure preview. The default value
    ;; is 'any, such that any key triggers the preview.
    ;; (setq consult-preview-key 'any)
    ;; (setq consult-preview-key "M-.")
    ;; (setq consult-preview-key '("S-<down>" "S-<up>"))
    ;; For some commands and buffer sources it is useful to configure the
    ;; :preview-key on a per-command basis using the `consult-customize' macro.
    (consult-customize
     consult-theme :preview-key '(:debounce 0.2 any)
     consult-ripgrep consult-git-grep consult-grep consult-man
     consult-bookmark consult-recent-file consult-xref
     consult--source-bookmark consult--source-file-register
     consult--source-recent-file consult--source-project-recent-file
     ;; :preview-key "M-."
     :preview-key '(:debounce 0.4 any))

    (setq consult-narrow-key "<") ;; "C-+"

    ;; Optionally make narrowing help available in the minibuffer.
    ;; You may want to use `embark-prefix-help-command' or which-key instead.
    ;; (keymap-set consult-narrow-map (concat consult-narrow-key " ?") #'consult-narrow-help)
  )

#+END_SRC

**** Embark 
#+NAME: embark 
#+BEGIN_SRC emacs-lisp

  ;;; Extended minibuffer actions and more (embark.el)
  (use-package embark
    :ensure nil
    :bind (("C-." . embark-act)
           :map minibuffer-local-map
           ("C-c C-c" . embark-collect)
           ("C-c C-e" . embark-export)))

  ;; Needed for correct exporting while using Embark with Consult
  ;; commands.
  (use-package embark-consult
    :ensure nil)

#+END_SRC

**** Wgrep 
#+NAME: wgrep 
#+BEGIN_SRC emacs-lisp

;; The `wgrep' packages lets us edit the results of a grep search
;; while inside a `grep-mode' buffer.  All we need is to toggle the
;; editable mode, make the changes, and then type C-c C-c to confirm
;; or C-c C-k to abort.
;;
;; Further reading: https://protesilaos.com/emacs/dotemacs#h:9a3581df-ab18-4266-815e-2edd7f7e4852
(use-package wgrep
  :ensure t
  :bind ( :map grep-mode-map
          ("e" . wgrep-change-to-wgrep-mode)
          ("C-x C-q" . wgrep-change-to-wgrep-mode)
          ("C-c C-c" . wgrep-finish-edit)))

#+END_SRC

*** Dashboard
#+NAME: enlight-settings
#+BEGIN_SRC emacs-lisp 
  
(use-package dashboard
  :ensure nil  ; Managed by Nix
  :config
  (dashboard-setup-startup-hook)
  (setq dashboard-startup-banner 'ascii
        dashboard-center-content t
        dashboard-items '((projects . 5)
                           (recents  . 5)))
  (setq dashboard-set-footer nil))

  (setq dashboard-banner-logo-title "This is your life")
  (setq dashboard-set-file-icons t)
  (setq dashboard-projects-backend 'projectile)

  (setq initial-buffer-choice (lambda ()
                                  (get-buffer-create "*dashboard*")
                                  (dashboard-refresh-buffer)))
  (setq dashboard-projects-switch-function 'counsel-projectile-switch-project-by-name)
#+END_SRC

** Keyboard
*** Buffers
#+NAME: next-buffer
#+BEGIN_SRC emacs-lisp

  (global-set-key (kbd "<C-tab>") 'next-buffer)

#+END_SRC
*** Reverse-im (reverse input) 
#+NAME: keyboard 
#+BEGIN_SRC emacs-lisp

  ;; Needed for `:after char-fold' to work
  (use-package char-fold
    :custom
    (char-fold-symmetric t)
    (search-default-mode #'char-fold-to-regexp))

  (use-package reverse-im
    :ensure nil 
    :demand t ; always load it
    :after char-fold ; but only after `char-fold' is loaded
    :bind
    ("M-T" . reverse-im-translate-word) ; to fix a word written in the wrong layout
    :custom
    ;; cache generated keymaps
    (reverse-im-cache-file (locate-user-emacs-file "reverse-im-cache.el"))
    ;; use lax matching
    (reverse-im-char-fold t)
    ;; advice read-char to fix commands that use their own shortcut mechanism
    (reverse-im-read-char-advice-function #'reverse-im-read-char-include)
    ;; translate these methods
    (reverse-im-input-methods '("russian-computer" "greek"))
    :config
    (reverse-im-mode t)) ; turn the mode on

#+END_SRC
*** Meow
#+NAME: meow-kbd
#+BEGIN_SRC emacs-lisp
  (when (require 'meow nil t)             
  (require 'meow-tree-sitter nil t)   
  (when (fboundp 'meow-setup)
    (meow-setup)
    (meow-global-mode 1)))
#+END_SRC

** Display options
*** Themes

****Modus-themes
#+NAME: modus-themes-autothemer
#+BEGIN_SRC emacs-lisp 

  ;; (     require 'modus-themes) 

  ;; ;; In all of the following, WEIGHT is a symbol such as `semibold',
  ;; ;; `light', `bold', or anything mentioned in `modus-themes-weights'.
  ;; (setq modus-themes-italic-constructs t
  ;;       modus-themes-bold-constructs t 
  ;;       modus-themes-mixed-fonts t
  ;;       modus-themes-variable-pitch-ui nil 
  ;;       modus-themes-custom-auto-reload t
  ;;       modus-themes-disable-other-themes t

  ;;       ;; Options for `modus-themes-prompts' are either nil (the
  ;;       ;; default), or a list of properties that may include any of those
  ;;       ;; symbols: `italic', `WEIGHT'
  ;;       modus-themes-prompts '(italic medium)

  ;;       ;; The `modus-themes-completions' is an alist that reads two
  ;;       ;; keys: `matches', `selection'.  Each accepts a nil value (or
  ;;       ;; empty list) or a list of properties that can include any of
  ;;       ;; the following (for WEIGHT read further below):
  ;;       ;;
  ;;       ;; `matches'   :: `underline', `italic', `WEIGHT'
  ;;       ;; `selection' :: `underline', `italic', `WEIGHT'
  ;;       modus-themes-completions
  ;;       '((matches . (semibold))
  ;;         (selection . (bold italic text-also)))

  ;;       modus-themes-org-blocks 'tinted-background

  ;;       modus-themes-to-toggle '(modus-vivendi modus-vivendi-tinted)

  ;;       ;; The `modus-themes-headings' is an alist: read the manual's
  ;;       ;; node about it or its doc string.  Basically, it supports
  ;;       ;; per-level configurations for the optional use of
  ;;       ;; `variable-pitch' typography, a height value as a multiple of
  ;;       ;; the base font size (e.g. 1.5), and a `WEIGHT'.
  ;;       modus-themes-headings
  ;;       '((1 . (variable-pitch 1.5))
  ;;         (2 . (1.3))
  ;;         (agenda-date . (1.3))
  ;;         (agenda-structure . (variable-pitch light 1.8))
  ;;         (t . (1.1))))

  ;; ;; Maybe define some palette overrides, such as by using our presets
  ;; (setq modus-themes-common-palette-overrides
  ;;       modus-themes-preset-overrides-intense)

  ;; (mapc #'disable-theme custom-enabled-themes)

  ;; ;; Load the theme of your choice:
  ;; (load-theme 'modus-vivendi :no-confirm)

  ;; (define-key global-map (kbd "<f5>") #'modus-themes-toggle)

#+END_SRC

**** Ef-themes
#+NAME: ef-themes-autothemer
#+BEGIN_SRC emacs-lisp 

  (require 'ef-themes)
  (setq ef-themes-to-toggle '(ef-owl ef-maris-dark))
  (setq ef-themes-headings ; read the manual's entry or the doc string
        '((0 variable-pitch regular 1.9)
          (1 variable-pitch regular 1.8)
          (2 variable-pitch light 1.7)
          (3 variable-pitch light 1.6)
          (4 variable-pitch light 1.5)
          (5 variable-pitch light 1.4) ; absence of weight means `bold'
          (6 variable-pitch light 1.3)
          (7 variable-pitch light 1.2)
          (t variable-pitch light 1.1)))

  (setq ef-themes-mixed-fonts t
        ef-themes-variable-pitch-ui t)

  (mapc #'disable-theme custom-enabled-themes)

  (load-theme 'ef-owl :no-confirm)

  (define-key global-map (kbd "<f5>") #'ef-themes-toggle)

#+END_SRC

*** Pulsar 
#+NAME: pulsar 
#+BEGIN_SRC emacs-lisp
  
  ;;;; Pulsar
  ;; Read the pulsar manual: <https://protesilaos.com/emacs/pulsar>.
  (use-package pulsar
    :ensure nil
    :config
    (setq pulsar-pulse t
          pulsar-delay 0.055
          pulsar-iterations 5
          pulsar-face 'pulsar-green
          pulsar-region-face 'pulsar-cyan
          pulsar-highlight-face 'pulsar-magenta)
    ;; Pulse after `pulsar-pulse-region-functions'.
    (setq pulsar-pulse-region-functions pulsar-pulse-region-common-functions)
    :hook
    ;; There are convenience functions/commands which pulse the line using
    ;; a specific colour: `pulsar-pulse-line-red' is one of them.
    ((next-error . (pulsar-pulse-line-red pulsar-recenter-top pulsar-reveal-entry))
     (minibuffer-setup . pulsar-pulse-line-red)
     ;; Pulse right after the use of `pulsar-pulse-functions' and
     ;; `pulsar-pulse-region-functions'.  The default value of the
     ;; former user option is comprehensive.
     (after-init . pulsar-global-mode))
    :bind
    ;; pulsar does not define any key bindings.  This is just my personal
    ;; preference.  Remember to read the manual on the matter.  Evaluate:
    ;;
    ;; (info "(elisp) Key Binding Conventions")
    (("C-x l" . pulsar-pulse-line) ; override `count-lines-page'
     ("C-x L" . pulsar-highlight-dwim))) ; or use `pulsar-highlight-line'

#+END_SRC

*** Golden-ratio 
Use 'golden-ratio-toggle-widescreen' if splits are too wide
#+NAME: golden-ratio 
#+BEGIN_SRC emacs-lisp

  ;; The desired ratio of the focused window's size.
  (setopt auto-resize-ratio 0.7)

  (defun win/auto-resize ()
    (let* (
           (height (floor (* auto-resize-ratio (frame-height))))
           (width (floor (* auto-resize-ratio (frame-width))))
           ;; INFO We need to calculate by how much we should enlarge
           ;; focused window because Emacs does not allow setting the
           ;; window dimensions directly.
           (h-diff (max 0 (- height (window-height))))
           (w-diff (max 0 (- width (window-width)))))
      (enlarge-window h-diff)
      (enlarge-window w-diff t)))
  (setopt window-min-height 10)
  (setopt window-min-width 10)

  (advice-add 'other-window :after (lambda (&rest args)
                                     (win/auto-resize)))

  (advice-add 'windmove-up    :after 'win/auto-resize)
  (advice-add 'windmove-down  :after 'win/auto-resize)
  (advice-add 'windmove-right :after 'win/auto-resize)
  (advice-add 'windmove-left  :after 'win/auto-resize)
  
#+END_SRC

** Global Settings
*** Global Modes
#+NAME: global-modes
#+BEGIN_SRC emacs-lisp
  
  (setq use-short-answers t)
  (global-visual-line-mode t) ;; Wraps lines everywhere
  (global-auto-revert-mode t) ;; Auto refresh buffers from disk

  ;; –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å–∫–æ–±–æ–∫
  (show-paren-mode t)  ;; –í–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º
  (setq show-paren-style 'mixed) ;; –õ—É—á—à–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å (–≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤—Å–µ–π –ø–∞—Ä—ã –∏–ª–∏ –æ–¥–Ω–æ–π)
  (setq show-paren-delay 0)      ;; –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ 

  (setq warning-minimum-level :error)

  ;; –ù—É–º–µ—Ä–∞—Ü–∏—è
  (global-display-line-numbers-mode t)
  (setq display-line-numbers-type 'relative)

#+END_SRC

** Org mode
*** Install package
**** Leader key shortcuts
#+NAME::org-mode-quick-entry
#+BEGIN_SRC emacs-lisp

  ;; ESC will also cancel/quit/etc.
  (global-set-key (kbd "<escape>") 'keyboard-escape-quit)
  (use-package general
    :config
    ;; (general-evil-setup t)
    (general-create-definer dl/leader-keys
      :keymaps '(normal visual emacs)
      :prefix ","))

  (defvar current-time-format "%H:%M:%S"
    "Format of date to insert with `insert-current-time' func.
  Note the weekly scope of the command's precision.")

  (defun dl/find-file (path)
    "Helper function to open a file in a buffer"
    (interactive)
    (find-file path))

  (defun dl/load-buffer-with-emacs-config ()
    "Open the emacs configuration"
    (interactive)
    (dl/find-file "~/.local/share/src/nixos-config/modules/shared/config/emacs/config.org"))

  (defun dl/load-buffer-with-nix-config ()
    "Open the emacs configuration"
    (interactive)
    (dl/find-file "~/.local/share/src/nixos-config/modules/shared/home-manager.nix"))

  (defun dl/reload-emacs ()
    "Reload the emacs configuration"
    (interactive)
    (load "~/.emacs.d/init.el"))

  ;; Emacs relates shortcuts
  (dl/leader-keys
    "e"  '(:ignore t :which-key "emacs")
    "ee" '(dl/load-buffer-with-emacs-config :which-key "open emacs config")
    "er" '(dl/reload-emacs :which-key "reload emacs"))

  (with-eval-after-load 'org
    (let ((png (cdr (assoc 'dvipng org-preview-latex-process-alist))))
      (plist-put png :latex-compiler
  	       '("latex -interaction nonstopmode -output-directory %o %F"))
      (plist-put png :image-converter
  	       '("dvipng -D %D -T tight -o %O %F"))
      (plist-put png :transparent-image-converter
  	       '("dvipng -D %D -T tight -bg Transparent -o %O %F"))))

  (use-package math-preview
    :custom (math-preview-command "/Users/alexeykotomin/.nix-profile/bin/math-preview"))

  (use-package obsidian
    :config
    (global-obsidian-mode t)
    (obsidian-backlinks-mode t)
    :custom
    ;; location of obsidian vault
    (obsidian-directory "~/Documents/notes/obsidian")
    ;; Default location for new notes from `obsidian-capture'
    (obsidian-inbox-directory "Inbox")
    ;; Useful if you're going to be using wiki links
    (markdown-enable-wiki-links t)

    ;; These bindings are only suggestions; it's okay to use other bindings
    :bind (:map obsidian-mode-map
                ;; Create note
                ("C-c C-n" . obsidian-capture)
                ;; If you prefer you can use `obsidian-insert-wikilink'
                ("C-c C-l" . obsidian-insert-link)
                ;; Open file pointed to by link at point
                ("C-c C-o" . obsidian-follow-link-at-point)
                ;; Open a different note from vault
                ("C-c C-p" . obsidian-jump)
                ;; Follow a backlink for the current file
                ("C-c C-b" . obsidian-backlink-jump)))

#+END_SRC

*** UI improvements
**** Org-modern 
#+NAME::org-mode-visuals
#+BEGIN_SRC emacs-lisp
  
  (use-package org-modern
    :ensure nil 
    :config
      ;; Add frame borders and window dividers
      (modify-all-frames-parameters
      '((right-divider-width . 40)
      (internal-border-width . 40)))
      (dolist (face '(window-divider
                      window-divider-first-pixel
                      window-divider-last-pixel))
      (face-spec-reset-face face)
      (set-face-foreground face (face-attribute 'default :background)))
      (set-face-background 'fringe (face-attribute 'default :background))

      (setq
      ;; Edit settings
      org-auto-align-tags nil
      org-tags-column 0
      org-catch-invisible-edits 'show-and-error
      org-special-ctrl-a/e t
      org-insert-heading-respect-content t

      ;; Org styling, hide markup etc.
      org-hide-emphasis-markers t
      org-pretty-entities t
      org-agenda-tags-column 0
      org-ellipsis "‚Ä¶")

      (global-org-modern-mode))

#+END_SRC

** Evil mode (aka Vim mode)
*** Install package
#+NAME: evil-packages
#+BEGIN_SRC emacs-lisp
  
  ;; (defun dl/evil-hook ()
  ;;   (dolist (mode '(eshell-mode
  ;;                   git-rebase-mode
  ;;                   dashboard-mode
  ;;                   term-mode))
  ;;   (add-to-list 'evil-emacs-state-modes mode))) ;; no evil mode for these modes


  ;; (use-package evil
  ;;   :init
  ;;     (setq evil-want-integration t) ;; TODO: resear;; ch what this does
  ;;     (setq evil-want-keybinding nil) ;; Required for evil-collection
  ;;     (setq evil-want-fine-undo 'fine) ;; undo/redo each motion
  ;;     (setq evil-want-Y-yank-to-eol t) ;; Y copies to end of line like vim
  ;;     (setq evil-want-C-u-scroll t) ;; vim like scroll up
  ;;   :config
  ;;     (evil-mode 1)
  ;;     (dl/evil-hook)
  ;;     ;; Emacs "cancel" == vim "cancel"
  ;;     (define-key evil-insert-state-map (kbd "C-g") 'evil-normal-state))

  ;;   ;; Gives me vim bindings elsewhere in emacs
  ;;   (use-package evil-collection
  ;;     :after evil
  ;;     :init
  ;;   (setq evil-want-keybinding nil)
  ;;     ;; Define the variable before use
  ;;     (defvar evil-collection-mode-list nil)
  ;;     :config
  ;;     (setq evil-collection-mode-list (remove 'magit evil-collection-mode-list))
  ;;     (evil-collection-init))

  ;;   ;; Keybindings in org mode
  ;;   (use-package evil-org
  ;;   :after evil
  ;;   :hook
  ;;       (org-mode . evil-org-mode)
  ;;   :config
  ;;       (require 'evil-org-agenda)
  ;;       (evil-org-agenda-set-keys)
  ;;       ;; üîë –≤–∫–ª—é—á–∞–µ–º –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ —Ç–µ–º—ã
  ;;       (evil-org-set-key-theme '(navigation insert textobjects additional shift todo heading)))

  ;;   ;; Branching undo system
  ;;   (use-package undo-tree
  ;;     :after evil
  ;;     :diminish
  ;;     :config
  ;;     (evil-set-undo-system 'undo-tree)
  ;;     (global-undo-tree-mode 1))

  ;;   (use-package evil-commentary
  ;;     :after evil
  ;;     :config
  ;;     (evil-commentary-mode))

    ;; Keep undo files from littering directories
    (setq undo-tree-history-directory-alist '(("." . "~/.local/state/emacs/undo")))

#+END_SRC

** Managing files
*** File browser
#+BEGIN_SRC emacs-lisp
    (use-package nerd-icons-dired)

    (use-package dired
      :ensure nil
      :defer 1
      :commands (dired dired-jump)
      :config
        (setq dired-listing-switches "-agho --group-directories-first")
        (setq dired-hide-details-hide-symlink-targets nil)
        (put 'dired-find-alternate-file 'disabled nil)
        (setq delete-by-moving-to-trash t)
        (add-hook 'dired-load-hook
              (lambda ()
                (interactive)
                (dired-collapse)))
        (add-hook 'dired-mode-hook
              (lambda ()
                (interactive)
                (nerd-icons-dired-mode 1)
                (hl-line-mode 1))))
        (add-hook 'dired-mode-hook 'dired-hide-details-mode)t

    (use-package dired-ranger)
    (use-package dired-collapse)

    (require 'key-chord)
    (key-chord-mode 1)

    (key-chord-define-global "dd" (lambda() (interactive)
    (find-file "/Users/alexeykotomin/Downloads/")))
    (key-chord-define-global "ee" (lambda() (interactive)
    (find-file "/Users/alexeykotomin/.config/nix/modules/shared/config/emacs/")))
    (key-chord-define-global "bb" (lambda() (interactive)
    (find-file "/Users/alexeykotomin/Documents/library/")))
    (key-chord-define-global "ss" (lambda() (interactive)
    (find-file "/Users/alexeykotomin/s21_projects/")))

    (when (system-is-mac)
      (setq insert-directory-program
        (expand-file-name ".nix-profile/bin/ls" (getenv "HOME"))))
#+END_SRC

*** Backups and auto-save
These settings keep emacs from littering the filesystem with buffer backups. These files look like ~#yourfilename.txt#~ and would otherwise be dropped in your working directory.
#+NAME: backup-files
#+BEGIN_SRC emacs-lisp
(setq backup-directory-alist
      `((".*" . "~/.local/state/emacs/backup"))
      backup-by-copying t    ; Don't delink hardlinks
      version-control t      ; Use version numbers on backups
      delete-old-versions t) ; Automatically delete excess backups
#+END_SRC

#+NAME: local-file-transforms
#+BEGIN_SRC emacs-lisp
(setq auto-save-file-name-transforms
      `((".*" "~/.local/state/emacs/" t)))
(setq lock-file-name-transforms
      `((".*" "~/.local/state/emacs/lock-files/" t)))
#+END_SRC

*** Books & Docs
#+NAME: pdfs
#+BEGIN_SRC emacs-lisp

  ;; Remember that the website version of this manual shows the latest
  ;; developments, which may not be available in the package you are
  ;; using.  Instead of copying from the web site, refer to the version
  ;; of the documentation that comes with your package.  Evaluate:
  ;;
  ;;     (info "(denote) Sample configuration")
  (use-package denote
    :ensure nil
    :hook (dired-mode . denote-dired-mode)
    :bind
    (("C-c n n" . denote)
     ("C-c n r" . denote-rename-file)
     ("C-c n l" . denote-link)
     ("C-c n b" . denote-backlinks)
     ("C-c n d" . denote-dired)
     ("C-c n g" . denote-grep))
    :config
    (setq denote-directory (expand-file-name "~/Documents/notes/"))

    ;; Automatically rename Denote buffers when opening them so that
    ;; instead of their long file name they have, for example, a literal
    ;; "[D]" followed by the file's title.  Read the doc string of
    ;; `denote-rename-buffer-format' for how to modify this.
    (denote-rename-buffer-mode 1))

  (use-package denote-markdown
   :ensure nil
   ;; Bind these commands to key bindings of your choice.
   :commands ( denote-markdown-convert-links-to-file-paths
     denote-markdown-convert-links-to-denote-type
     denote-markdown-convert-links-to-obsidian-type
     denote-markdown-convert-obsidian-links-to-denote-type ))
  (use-package citar
  :custom
  (citar-bibliography '("~/bib/references.bib")))

  (use-package pdf-tools
  :ensure nil
  :config
  (pdf-loader-install))
  (add-hook 'pdf-view-mode-hook
          (lambda ()
            (display-line-numbers-mode -1)))
#+END_SRC

** Managing projects
*** Projectile
#+NAME: projectile
#+BEGIN_SRC emacs-lisp
  (use-package ripgrep)
  (use-package projectile
    :config (projectile-mode)
    :custom
      ((projectile-completion-system 'ivy))
    :bind-keymap
	    ("C-c p" . projectile-command-map)
      :init
      (setq projectile-enable-caching t)
      (setq projectile-sort-order 'recently-active)
      (setq projectile-switch-project-action #'projectile-dired))

      ;; –ü—É—Ç–∏ –∫ –∫—ç—à—É –∏ —Å–ø–∏—Å–∫—É –ø—Ä–æ–µ–∫—Ç–æ–≤ –≤ ~/.config/emacs/
      (setq projectile-cache-file
        (expand-file-name "projectile.cache" ak/config-dir))
      (setq projectile-known-projects-file
        (expand-file-name "projectile-bookmarks.eld" ak/config-dir))

  (setq projectile-project-root-files-bottom-up '("package.json" ".projectile" ".project" ".git"))
  (setq projectile-ignored-projects '("~/.emacs.d/"))
  (setq projectile-globally-ignored-directories '("dist" "node_modules" ".log" ".git"))

  ;; Gives me Ivy options in the Projectile menus
  (use-package counsel-projectile 
    :after projectile
    :config
    (counsel-projectile-mode 1))
  
  ;; Project-wide search keybindings
  (defun my/swiper-project ()
    "Search across all files in current project using ripgrep."
    (interactive)
    (counsel-rg nil (projectile-project-root)))
  
  ;; Search keybindings for projectile
  (dl/leader-keys
    "/"   '(counsel-projectile-rg :which-key "search project")
    "?"   '(my/swiper-project :which-key "search project (alt)")
    "a"   '(:ignore t :which-key "search")
    "aa"  '(swiper-all :which-key "search buffers") 
    "ap"  '(counsel-projectile-rg :which-key "search project")
    "ag"  '(counsel-projectile-grep :which-key "grep project")
    "af"  '(counsel-projectile-find-file :which-key "find file")
    "ad"  '(counsel-projectile-find-dir :which-key "find directory"))
  
  ;; Alternative global keybindings for quick access
  (global-set-key (kbd "C-c C-s") 'counsel-projectile-rg)
  (global-set-key (kbd "C-c s p") 'my/swiper-project)
  (global-set-key (kbd "C-c s a") 'swiper-all)
#+END_SRC

** Coding
*** Compile buffers
Everything related to ~M-x compile~.
#+NAME: compilation-buffer
#+BEGIN_SRC emacs-lisp
;; Auto scroll the buffer as we compile
(setq compilation-scroll-output t)

;; By default, eshell doesn't support ANSI colors. Enable them for compilation.
(require 'ansi-color)
(defun colorize-compilation-buffer ()
  (let ((inhibit-read-only t))
    (ansi-color-apply-on-region (point-min) (point-max))))
(add-hook 'compilation-filter-hook 'colorize-compilation-buffer)
#+END_SRC
*** LSP
#+NAME: lsp-mode
#+BEGIN_SRC emacs-lisp
  (use-package lsp-mode
    :commands lsp lsp-deferred
    :init
      (setq lsp-keymap-prefix "C-c l")
      (setq lsp-restart 'ignore)
      (setq lsp-headerline-breadcrumb-enable nil)
      (setq lsp-auto-guess-root t)
      (setq lsp-enable-which-key-integration t))

  (use-package lsp-ui
    :hook (lsp-mode . lsp-ui-mode)
    :custom
      (lsp-ui-doc-position 'bottom))

  (use-package lsp-treemacs
    :after lsp)

  (use-package company
    :after lsp-mode
    :hook (lsp-mode . company-mode)
    :bind (:map company-active-map
          ("<tab>" . company-complete-selection))
          (:map lsp-mode-map
          ("<tab>" . company-indent-or-complete-common))
     :custom
       (company-minimum-prefix-length 1)
       (company-idle-delay 0.0))

  (use-package company-box
    :hook (company-mode . company-box-mode))

  (add-hook 'lsp-mode-hook #'lsp-headerline-breadcrumb-mode)
#+END_SRC

**** Shortcuts
Leader keys for ~lsp-mode~.

#+NAME: lsp-leader-keys
#+BEGIN_SRC emacs-lisp
  (defun dl/lsp-find-references-other-window ()
    (interactive)
    (switch-to-buffer-other-window (current-buffer))
    (lsp-find-references))

  (defun dl/lsp-find-implementation-other-window ()
    (interactive)
    (switch-to-buffer-other-window (current-buffer))
    (lsp-find-implementation))

  (defun dl/lsp-find-definition-other-window ()
    (interactive)
    (switch-to-buffer-other-window (current-buffer))
    (lsp-find-definition))

  (dl/leader-keys
  "l"  '(:ignore t :which-key "lsp")
  "lf" '(dl/lsp-find-references-other-window :which-key "find references")
  "lc" '(dl/lsp-find-implementation-other-window :which-key "find implementation")
  "ls" '(lsp-treemacs-symbols :which-key "list symbols")
  "lt" '(flycheck-list-errors :which-key "list errors")
  "lh" '(lsp-treemacs-call-hierarchy :which-key "call hierarchy")
  "lF" '(lsp-format-buffer :which-key "format buffer")
  "li" '(lsp-organize-imports :which-key "organize imports")
  "ll" '(lsp :which-key "enable lsp mode")
  "lr" '(lsp-rename :which-key "rename")
  "ld" '(dl/lsp-find-definition-other-window :which-key "goto definition"))
#+END_SRC

*** Languages
**** Python
#+NAME: python
#+BEGIN_SRC emacs-lisp
  (use-package lsp-pyright
    :ensure nil  ; Managed by Nix
    :hook (python-mode . (lambda ()
      (require 'lsp-pyright)
      (lsp-deferred))))  ; or lsp-deferred

  (setq python-indent-offset 2)

  (use-package blacken
    :ensure nil)

  (setq blacken-line-length '88)
  (setq blacken-allow-py36 t)
  (setq blacken-executable "black")
  (setq blacken-fast-unsafe t)

  (add-hook 'python-mode-hook 'blacken-mode)
#+END_SRC

**** Shell scripts
#+NAME: shell-scripts
#+BEGIN_SRC emacs-lisp
  (add-to-list 'auto-mode-alist '("\\.env" . shell-script-mode))
#+END_SRC

**** YAML
#+NAME: yaml-mode
#+BEGIN_SRC emacs-lisp
  (use-package yaml-mode
    :commands (markdown-mode gfm-mode)
    :mode (("\\.yml\\'" . yaml-mode)))
#+END_SRC

**** kbd 
#+NAME: kbd 
#+BEGIN_SRC emacs-lisp
  ;; –ê—Å—Å–æ—Ü–∏–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã .kbd —Å lisp-mode
  (add-to-list 'auto-mode-alist '("\\.kbd\\'" . lisp-mode))
#+END_SRC

*** Infrastructure
**** Nix
Nix is my package manager and operating system of choice; this mode enables me to have a better time writing Nix expressions.

#+NAME: nix-mode
#+begin_src emacs-lisp
  (use-package nix-mode
    :mode "\\.nix\\'")
#+end_src

** Learning Emacs
*** org-babel
**** Show popup hints
#+BEGIN_SRC emacs-lisp
(use-package which-key
  :ensure nil  ; Managed by Nix
  :init
  (setq which-key-idle-delay 0.3
        which-key-idle-secondary-delay 0.1)
  :config
  (which-key-mode))

(use-package helpful
  :ensure nil  ; Managed by Nix
  :commands (helpful-callable helpful-variable helpful-key)
  :bind
  ([remap describe-function] . helpful-callable)
  ([remap describe-command]  . helpful-callable)
  ([remap describe-variable] . helpful-variable)
  ([remap describe-key]      . helpful-key))
#+END_SRC

**** Load languages to run in org mode code blocks
#+BEGIN_SRC emacs-lisp
  (with-eval-after-load 'org
    (org-babel-do-load-languages
    'org-babel-load-languages
    '(
      (emacs-lisp . t)
      (python . t)
      (sql . t)
      (shell . t)))
   )
#+END_SRC

